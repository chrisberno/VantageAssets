<html>
<script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
<script src="https://rawgit.com/peterdhl88/VantageAssets/master/AR.js/aframe/build/aframe-ar.js"> </script>
  <body style='margin : 0px; overflow: hidden;'>
    <script>
      AFRAME.registerComponent('mousex', {
        init: function () {
          onmousemove = function(e){
            var canvas = document.getElementById("canvasx");

            var mouse = new THREE.Vector2();
            var raycaster = new THREE.Raycaster();

            var rect = canvas.getBoundingClientRect();

            /* mouse.x = ( (e.clientX) / window.innerWidth ) * 2 - 1;
            mouse.y = - ( (e.clientY) / window.innerHeight ) * 2 + 1; */

            mouse.x = (e.targetTouches[0].pageX / window.innerwidth) * 2 - 1;
            mouse.y = -(e.targetTouches[0].pageY / window.innerHeight) * 2 + 1;
            
            //console.log(mouse.x, mouse.y);
            var boxEl = document.querySelector('#cursor');
            //boxEl.setAttribute('position', mouse.x + " " + mouse.y + " -1");
            //boxEl.setAttribute('position', "0.5 0 -1");

            //var camera = document.querySelector('#camera').getAttribute('camera');
            var aspectRatio = window.innerWidth / window.innerHeight;
            var aspectRatioReverse = window.innerHeight / window.innerWidth;
            var camera = new THREE.PerspectiveCamera( 80, aspectRatio, 1, 1000 );

            var vector = new THREE.Vector3( mouse.x, mouse.y, -(window.innerWidth / window.innerHeight) ).unproject( camera );
            //console.log(-(80 / window.innerWidth / window.innerHeight / 10) - 2);
            //console.log(Math.round(window.innerWidth / window.innerHeight * 100) / 100, Math.round(mouse.x * 100) / 100, Math.round(mouse.y * 100) / 100, Math.round(vector.x * 100) / 100, Math.round(vector.y * 100) / 100);
            boxEl.setAttribute('position', vector.x + " " + vector.y + " -1");
          }
        },
        touchstart = function(event) {
          var canvas = document.getElementById("canvasx");

            var mouse = new THREE.Vector2();
            var raycaster = new THREE.Raycaster();

            var rect = canvas.getBoundingClientRect();

            mouse.x = (event.targetTouches[0].pageX / window.innerwidth) * 2 - 1;
            mouse.y = -(event.targetTouches[0].pageY / window.innerHeight) * 2 + 1;
            
            //console.log(mouse.x, mouse.y);
            var boxEl = document.querySelector('#cursor');
            //boxEl.setAttribute('position', mouse.x + " " + mouse.y + " -1");
            //boxEl.setAttribute('position', "0.5 0 -1");

            //var camera = document.querySelector('#camera').getAttribute('camera');
            var aspectRatio = window.innerWidth / window.innerHeight;
            var aspectRatioReverse = window.innerHeight / window.innerWidth;
            var camera = new THREE.PerspectiveCamera( 80, aspectRatio, 1, 1000 );

            var vector = new THREE.Vector3( mouse.x, mouse.y, -(window.innerWidth / window.innerHeight) ).unproject( camera );
            //console.log(-(80 / window.innerWidth / window.innerHeight / 10) - 2);
            //console.log(Math.round(window.innerWidth / window.innerHeight * 100) / 100, Math.round(mouse.x * 100) / 100, Math.round(mouse.y * 100) / 100, Math.round(vector.x * 100) / 100, Math.round(vector.y * 100) / 100);
            boxEl.setAttribute('position', vector.x + " " + vector.y + " -1");
        }
        /* ,
        update: function () {
          var cursor = this.el.getAttribute('cursor');
          console.log(cursor.fuse);
          console.log("a");
        } */
      });
      AFRAME.registerComponent('cursor-listener', {
          schema: {
            target: {type: 'selector'}
          },
          init: function () {
              this.el.addEventListener('click', function (evt) {
                console.log('I was clicked at: ', evt.detail.intersection.point);
              });

              var el = this.el;
              var targetEl = this.data.target;  // Target to change material.

              el.addEventListener('click', function () {
                var mesh = targetEl.getObject3D('mesh');
                mesh.traverse(function( child ) { 
                  if ( child instanceof THREE.Mesh ) {
                    child.material = Red;
                  }
                });  // Do your logic here.
              });
            }
          });

        AFRAME.registerComponent('collider-check', {
          dependencies: ['raycaster'],
          init: function () {
            this.el.addEventListener('raycaster-intersected', function () {
              console.log('Player hit something!');
            });
          }
        });
      </script>
    <a-scene embedded arjs id="canvasx"y>
        <a-assets>
          <a-asset-item id="text" src="https://cdn.rawgit.com/peterdhl88/VantageAssets/master/OBJtest/TestText.gltf"></a-asset-item>
          <a-asset-item id="tree" src="https://cdn.rawgit.com/peterdhl88/VantageAssets/master/microphone/microphone.gltf"></a-asset-item>
        </a-assets>
      <a-marker preset='custom' type='pattern' url='AR.js/three.js/examples/marker-training/examples/pattern-files/pattern-taijitu.patt'>
        <a-entity gltf-model="#tree"></a-entity>
        <a-entity id="box" cursor-listener geometry="primitive: box" material="color: blue"></a-entity>
      </a-marker>
  	  <a-entity camera id="camera">
        <a-entity id="cursor" mousex cursor="fuse: false; rayOrigin: 'mouse'"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: white; shader: flat">
        </a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>